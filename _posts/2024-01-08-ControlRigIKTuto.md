---
layout: post
categories: blog
title: 컨트롤 릭 IK 듀토리얼
date: 2024-01-08
tags: [UnrealEngine,Unreal,UE5,개인프로젝트,ControlRigIK]
toc:  true
---

컨트롤릭을 통한 IK적용은 기존에 애니메이션 인스턴스 내부에서 적용하던 방식과 비슷하다.
1. 내가 IK를 적용하길 원하는 본에서
2. 라인트레이스를 쏴서
3. 히트한 좌표를 이용해
4. 본을 움직인다

두가지 경우로 나눌 것이다.
1. IK본이 이미 있는 경우
2. IK본이 없는 경우

## 공통 준비
일단 어떠한 경우든, 라인트레이스는 본마다 쏴야 하니까, 재사용하기 편하도록 함수로 만들어 처리하도록 하자.

### 함수 생성
![ex_screenshot](/assets/images/unreal/myProject/24.01.08/rig_trace.png)

입력을 "릭 엘리먼트 키"를 파라미터로 받는다.
이 변수는 릭에 이용할 수 있는 여러 타입이 있는데, 어떤 타입을 이용할 것인지
그리고 그 타입과 일치하는 것의 이름이 무엇인지 받을 수 있다.

1. 받아온 타입과 이름을 가지고, 특정 본의 트랜스폼 정보를 가져온다.
2. 라인트레이스가 시작할 좌표를 구한다. 본의 위치에서 30만큼 위로 올린 지점을 구했다. (Add로 5만큼 Y값을 더해주고 있는데, 굳이 없어도 될 듯?)
3. 라인트레이스가 끝날 좌표를 구한다. 본의 위치에서 100만큼 아래 지점을 구했다.
4. 구한 좌표로 SphereTrace 한 뒤, 결과로 나온 히트 로케이션을 리턴한다.

이렇게 생성된 함수는, 다른 캐릭터의 ControlRig에서도 불러 사용할 수 있더라

### 변수 생성
만든 함수의 결과로 구한 좌표중. Z값만 필요하니까 Z값을 저장할 변수를 선언하자.
다리가 두개면 두개의 변수
네개면 네개의 변수
n개면 n개의 변수를 만들면 되겠다.

나는 사슴에다 쓸거니까, 4개의 변수를 선언할 것이고

각각 이름을 다음과 같이 정해주겠다
- float FloorLH(왼손, 앞발)
- float FloorRH(오른손, 앞발)
- float FloorLF(왼발)
- float FloorRF(오른발)

이 변수에 각각 본마다 실행한 라인트레이스 결과값이 저장될 것이다.

### 적용
내가 사용할 스켈레톤 구조에 IK본이 없는 경우, 가상의 본을 만들어 사용할 것이다.
하지만, IK본이 같이 있는 경우에는 굳이 가상의 본을 만들 필요 없이. 그냥 IK본을 사용하면 된다.
아래 내용에서 가상의 본이 들어갈 자리에 IK본을 넣어주면 된다는 뜻이다.

#### 가상 본 생성
컨트롤릭에서는 스켈레톤 구조에 내 마음대로 가상의 본을 추가할 수 있다.
내가 IK로 조정할 본마다 가상의 본을 추가해주고, 가상의 본을 움직인 후, 기존의 본의 위치를 가상의 본 위치로 갱신시킬것이다.


내가 가상의 본을 생성하길 원하는 원래 본 이름을 우클릭 한 뒤, 신규 - 새본 을 누르면 가상 본이 추가된다.
총 7개의 가상의 본을 추가하자. 구분을 위해서 가상본 이름을 소괄호 안에다 적어놓겠다.
- RightHand (TempRHand)
- LeftHand (TempLHand)
- RightFoot (TempRFoot)
- LeftFoot (TempLFoot)
- Neck (TempNeck)
- Head (TempHead)
- Pelvis (TempPelvis)

보면, 네 다리 이외에 3개가 더 추가되었는데, 이유는 다음과 같다.
경사로에서 다리만 굽힐게 아니라 경사진 만큼 골반, 머리, 목도 같이 회전하기 위함.
내리막길에서 앞다리만 늘어나 있으면 이상하지 않은가?

이렇게 추가된 가상 본은 전부 기존의 본 위치에 종속되어 있는데, 다 때어주도록 하자.
가상본을 우클릭 하고 부모 해제 하면 된다. 
부모가 해제된 가상의 본은 계층구조 가장 아랫쪽으로 내려가게 된다.




